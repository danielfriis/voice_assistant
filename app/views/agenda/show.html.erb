<%= turbo_stream_from "todos" %>

<div class="h-dvh">
  <div class="flex h-full flex-col">
    <header class="flex flex-none items-center justify-between bg-gray-50 border-b border-gray-200 px-6 py-4">
      <div>
        <h1 class="text-lg/6 font-semibold text-gray-900">
          <time datetime="<%= @date.strftime('%Y-%m-%d') %>" class="sm:hidden"><%= @date.strftime('%b %d, %Y') %></time>
          <time datetime="<%= @date.strftime('%Y-%m-%d') %>" class="hidden sm:inline"><%= @date.strftime('%B %d, %Y') %></time>
        </h1>
        <p class="mt-1 text-sm/4 text-gray-500"><%= @date.strftime('%A') %></p>
      </div>
      <div class="flex items-center">
        <div class="relative flex items-center rounded-md bg-white shadow-xs md:items-stretch">
          <%= link_to agenda_path(date: (@date - 1.day).strftime('%Y-%m-%d')), class: "flex h-9 w-12 items-center justify-center rounded-l-md border-y border-l border-gray-300 pr-1 text-gray-400 hover:text-gray-500 focus:relative md:w-9 md:pr-0 md:hover:bg-gray-50" do %>
            <span class="sr-only">Previous day</span>
            <svg class="size-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
              <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
            </svg>
          <% end %>
          <%= link_to agenda_path(date: Date.today.strftime('%Y-%m-%d')), class: "hidden content-center border-y border-gray-300 px-3.5 text-sm font-semibold text-gray-900 hover:bg-gray-50 focus:relative md:block" do %>
            Today
          <% end %>
          <%= link_to agenda_path(date: (@date + 1.day).strftime('%Y-%m-%d')), class: "flex h-9 w-12 items-center justify-center rounded-r-md border-y border-r border-gray-300 pl-1 text-gray-400 hover:text-gray-500 focus:relative md:w-9 md:pl-0 md:hover:bg-gray-50" do %>
            <span class="sr-only">Next day</span>
            <svg class="size-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
              <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
            </svg>
          <% end %>
        </div>
        <div class="hidden md:ml-4 md:hidden md:items-center">
          <div class="relative">
            <button type="button" class="flex items-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-xs ring-1 ring-gray-300 ring-inset hover:bg-gray-50" id="menu-button" aria-expanded="false" aria-haspopup="true">
              Day view
              <svg class="-mr-1 size-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
                <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
              </svg>
            </button>

            <!--
              Dropdown menu, show/hide based on menu state.

              Entering: "transition ease-out duration-100"
                From: "transform opacity-0 scale-95"
                To: "transform opacity-100 scale-100"
              Leaving: "transition ease-in duration-75"
                From: "transform opacity-100 scale-100"
                To: "transform opacity-0 scale-95"
            -->
            <div class="absolute right-0 z-10 mt-3 w-36 origin-top-right overflow-hidden rounded-md bg-white shadow-lg ring-1 ring-black/5 focus:outline-hidden" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
              <div class="py-1" role="none">
                <!-- Active: "bg-gray-100 text-gray-900 outline-hidden", Not Active: "text-gray-700" -->
                <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-item-0">Day view</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-item-1">Week view</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-item-2">Month view</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-item-3">Year view</a>
              </div>
            </div>
          </div>
          <div class="ml-6 h-6 w-px bg-gray-300"></div>
        </div>
        <div data-controller="webrtc-chat">
          <button data-webrtc-chat-target="toggleButton" data-action="click->webrtc-chat#toggleChat" type="button" class="cursor-pointer ml-6 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-xs hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500">
            Start Chat
          </button>
          <audio data-webrtc-chat-target="audioOutput"></audio>
        </div>
        <div class="relative ml-6 md:hidden">
          <button type="button" class="-mx-2 flex items-center rounded-full border border-transparent p-2 text-gray-400 hover:text-gray-500" id="menu-0-button" aria-expanded="false" aria-haspopup="true">
            <span class="sr-only">Open menu</span>
            <svg class="size-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
              <path d="M3 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM8.5 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM15.5 8.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z" />
            </svg>
          </button>

          <!--
            Dropdown menu, show/hide based on menu state.

            Entering: "transition ease-out duration-100"
              From: "transform opacity-0 scale-95"
              To: "transform opacity-100 scale-100"
            Leaving: "transition ease-in duration-75"
              From: "transform opacity-100 scale-100"
              To: "transform opacity-0 scale-95"
          -->
          <div class="absolute right-0 z-10 mt-3 w-36 origin-top-right divide-y divide-gray-100 overflow-hidden rounded-md bg-white shadow-lg ring-1 ring-black/5 focus:outline-hidden" role="menu" aria-orientation="vertical" aria-labelledby="menu-0-button" tabindex="-1">
            <div class="py-1" role="none">
              <!-- Active: "bg-gray-100 text-gray-900 outline-hidden", Not Active: "text-gray-700" -->
              <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-0-item-0">Create event</a>
            </div>
            <div class="py-1" role="none">
              <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-0-item-1">Go to today</a>
            </div>
            <div class="py-1" role="none">
              <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-0-item-2">Day view</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-0-item-3">Week view</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-0-item-4">Month view</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700" role="menuitem" tabindex="-1" id="menu-0-item-5">Year view</a>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="isolate flex flex-auto overflow-hidden bg-white">
      <div class="flex flex-auto flex-col overflow-auto" 
           data-controller="calendar-scroll"
           data-calendar-scroll-target="container">
        <div class="flex w-full flex-auto">
          <div class="w-14 flex-none bg-white ring-1 ring-gray-100"></div>
          <div class="grid flex-auto grid-cols-1 grid-rows-1">
            <!-- Horizontal lines -->
            <div class="col-start-1 col-end-2 row-start-1 grid divide-y divide-gray-100" style="grid-template-rows: repeat(48, minmax(3.5rem, 1fr))">
              <div class="row-end-1 h-7"></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">12AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">1AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">2AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">3AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">4AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">5AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">6AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">7AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">8AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">9AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">10AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">11AM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">12PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">1PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">2PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">3PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">4PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">5PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">6PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">7PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">8PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">9PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">10PM</div>
              </div>
              <div></div>
              <div>
                <div class="-mt-2.5 -ml-14 w-14 pr-2 text-right text-xs/5 text-gray-400">11PM</div>
              </div>
              <div></div>
            </div>

            <!-- Current time indicator -->
            <% if @date == Date.today %>
              <div class="col-start-1 col-end-2 row-start-1 grid grid-cols-1" style="grid-template-rows: 1.75rem repeat(288, minmax(0, 1fr)) auto">
                <div data-controller="current-time" 
                    data-current-time-target="indicator"
                    class="relative mt-px flex pointer-events-none"
                    style="display: none;"
                    >
                  <div class="absolute inset-0 flex">
                    <div class="w-full relative">
                      <div class="absolute left-0 right-0 h-px bg-red-400"></div>
                      <div class="absolute -ml-1.5 -mt-1.5 w-3 h-3 rounded-full bg-red-400"></div>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>

            <!-- Events -->
            <ol class="col-start-1 col-end-2 row-start-1 grid grid-cols-1" style="grid-template-rows: 1.75rem repeat(288, minmax(0, 1fr)) auto">
              <% @events.each do |event| %>
                <% next if event.start.date_time.nil? %>
                <li class="relative -mt-1 flex" style="grid-row: <%= 2 + event.start.date_time.strftime('%H').to_i * 12 + (event.start.date_time.strftime('%M').to_i * 12.0 / 60).round %> / span <%= (((event.end.date_time - event.start.date_time) * 24 * 12).to_i) %>">
                  <a href="#" class="group absolute inset-1 flex flex-col overflow-y-auto rounded-lg bg-blue-50 p-2 text-xs/5 hover:bg-blue-100">
                    <p class="order-1 font-semibold text-blue-700"><%= event.summary %></p>
                    <p class="text-blue-500 group-hover:text-blue-700"><time datetime="<%= event.start.date_time.strftime('%Y-%m-%d') %>T<%= event.start.date_time.strftime('%H:%M') %>"><%= event.start.date_time.strftime('%H:%M') %></time></p>
                  </a>
                </li>
              <% end %>
            </ol>
          </div>
        </div>
      </div>
      <div class="hidden w-1/2 max-w-md flex-none border-l border-gray-100 px-8 py-10 md:block">
        <div class="flex flex-col w-full max-w-2xl mx-auto">
          <% overdue = @todos.select { |todo| todo.due_date && (todo.due_date < Date.today) } %>
          <% today = @todos.select { |todo| todo.due_date && (todo.due_date == Date.today) } %>
          <% future = @todos.select { |todo| todo.due_date && (todo.due_date > Date.today) } %>
          <% no_due_date = @todos.select { |todo| todo.due_date.nil? } %>

          <div id="overdue" class="mb-6">
            <h3 class="text-sm font-medium text-red-500 mb-3 last:hidden">Overdue</h3>
            <%= render overdue %>
          </div>

          <div id="today" class="mb-6">
            <h3 class="text-sm font-medium text-gray-500 mb-3 last:hidden">Today</h3>
            <%= render today %>
          </div>

          <div id="future" class="mb-6">
            <h3 class="text-sm font-medium text-gray-500 mb-3 last:hidden">Future</h3>
            <%= render future %>
          </div>

          <div id="no-due-date" class="mb-6">
            <h3 class="text-sm font-medium text-gray-500 mb-3 last:hidden">No Due Date</h3>
            <%= render no_due_date %>
          </div>
        </div>
        <%= link_to "Sign out", session_path, data: { turbo_method: :delete } %>
      </div>
    </div>
  </div>
</div>